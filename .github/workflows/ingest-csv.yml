name: Ingest CSV → tools.json & logos

on:
  push:
    paths:
      - "data/sources/places.csv"
      - "scripts/ingest/csv_to_tools.py"
      - "data/categories.json"
      - "data/schema/tools.schema.json"
      - "requirements.txt"
  schedule:
    - cron: "15 20 * * *"  # daily (20:15 UTC ≈ 00:15 Muscat)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Validate CSV (basic)
        run: |
          python - <<'PY'
          import csv, sys, re
          from pathlib import Path

          CSV = Path("data/sources/places.csv")

          # 'url' is OPTIONAL now. We warn if it's missing.
          required = ["name", "category", "tagline"]
          slug_re = re.compile(r"^[a-z0-9-]+$")

          with CSV.open("r", encoding="utf-8-sig") as f:
              rdr = csv.DictReader(f)
              for i, row in enumerate(rdr, start=2):  # account for header line
                  # Hard requirements
                  for k in required:
                      if not (row.get(k) or "").strip():
                          sys.exit(f"Missing required '{k}' at CSV line {i}")

                  # Soft check (warn only)
                  if not (row.get("url") or "").strip():
                      print(f"[warn] Missing url at CSV line {i}")

                  # Slug sanity (if provided)
                  slug = (row.get("slug") or "").strip()
                  if slug and not slug_re.match(slug):
                      sys.exit(f"Bad slug '{slug}' at line {i} (use lowercase letters, numbers, hyphens)")

          print("[ok] CSV basic validation passed.")
          PY

      - name: Ingest CSV
        run: |
          python scripts/ingest/csv_to_tools.py

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add data/tools.json assets/images/
          if ! git diff --cached --quiet; then
            git commit -m "chore(data): ingest CSV → tools.json & logos"
            git push
          else
            echo "No changes to commit."
          fi
